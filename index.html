<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>雷射切管估價工具（依管徑分組）</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body { font-family: sans-serif; padding: 20px; background: #f8f8f8; }
    .row { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 10px; align-items: center; }
    label, input, select, button { font-size: 16px; }
    .result { margin-top: 20px; background: #fff; padding: 15px; border-radius: 8px; white-space: pre-line; box-shadow: 0 0 6px rgba(0,0,0,0.1); }
  </style>
</head>
<body>
  <h2>雷射切管估價工具（依管徑分組）</h2>

  <div id="rows"></div>
  <button onclick="addRow()">新增項目</button>
  <button onclick="estimate()">計算估價</button>

  <div class="result" id="output">請輸入資料後按下「計算估價」</div>

  <script>
    let rowCount = 0;
    const maxLen = 5750;

    function addRow() {
      const row = document.createElement("div");
      row.className = "row";
      row.innerHTML = `
        <label>管徑：</label>
        <input type="number" id="dia${rowCount}" placeholder="如50" style="width:60px" />
        <label>長度：</label>
        <input type="number" id="len${rowCount}" placeholder="如100" style="width:60px" />
        <label>數量：</label>
        <input type="number" id="qty${rowCount}" placeholder="件數" style="width:60px" />
        <label>孔數：</label>
        <input type="number" id="holes${rowCount}" value="3" style="width:60px" />
        <label>厚度：</label>
        <input type="number" step="0.1" id="thk${rowCount}" value="2.0" style="width:60px" />
      `;
      document.getElementById("rows").appendChild(row);
      rowCount++;
    }

    function estimate() {
      const group = {};
      let grandTotal = 0;
      let output = "";

      for (let i = 0; i < rowCount; i++) {
        const dia = document.getElementById(`dia${i}`).value;
        const len = parseFloat(document.getElementById(`len${i}`).value);
        const qty = parseInt(document.getElementById(`qty${i}`).value);
        const holes = parseInt(document.getElementById(`holes${i}`).value);
        const thk = parseFloat(document.getElementById(`thk${i}`).value);
        if (!dia || !len || !qty || !holes || !thk) continue;

        const key = dia + "mm";
        if (!group[key]) group[key] = { totalLen: 0, qty: 0, pipeCost: 0, unitCost: 0 };

        const costPerUnit = (holes * 5) + 10;
        const totalLen = len * qty;

        group[key].totalLen += totalLen;
        group[key].qty += qty;
        group[key].pipeCost = thk <= 2.5 ? 200 : 300;
        group[key].unitCost = costPerUnit;
      }

      for (const dia in group) {
        const g = group[dia];
        const pipes = Math.ceil(g.totalLen / maxLen);
        const pipeCostTotal = pipes * g.pipeCost;
        const processTotal = g.unitCost * g.qty;
        const subtotal = pipeCostTotal + processTotal;
        grandTotal += subtotal;

        output += `【${dia}】
` +
                  `  加工費：${g.unitCost} x ${g.qty} = $${processTotal}
` +
                  `  材料支數：${pipes} 支 × $${g.pipeCost} = $${pipeCostTotal}
` +
                  `  小計：$${subtotal}

`;
      }

      output += `🔶 總估價金額：$${grandTotal}`;
      document.getElementById("output").innerText = output || "請輸入完整項目資料";
    }

    window.onload = () => addRow();
  </script>


<script>
  // PDF 匯出已移除 {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    const lines = document.getElementById("output").innerText.split("\n");

    let y = 20;
    doc.setFontSize(14);
    doc.text("Laser Tube Cutting Quotation", 15, y);
    y += 10;
    doc.setFontSize(11);

    for (let i = 0; i < lines.length; i++) {
      const line = lines[i];
      if (y > 280) {
        doc.addPage();
        y = 20;
      }
      doc.text(line, 15, y);
      y += 7;
    }

    const date = new Date().toISOString().split("T")[0];
    doc.save(`laser_quote_${date}.pdf`);
  }
</script>
</body>
</html>
